<?xml version="1.0" encoding="UTF-8"?>
<!--
This file was generated by Altova MapForce 2007

YOU SHOULD NOT MODIFY THIS FILE, BECAUSE IT WILL BE
OVERWRITTEN WHEN YOU RE-RUN CODE GENERATION.

Refer to the Altova MapForce 2007 Documentation for further details.
http://www.altova.com/mapforce
-->
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xs="http://www.w3.org/2001/XMLSchema" exclude-result-prefixes="xs">
	<xsl:output method="xml" encoding="UTF-8" indent="yes"/>
	<xsl:template match="/ThirdPartyFlatFileDetailCollection">
		<ThirdPartyFlatFileDetailCollection>
			<xsl:attribute name="xsi:noNamespaceSchemaLocation">C:/UpdatedTP/Prana_Final.xsd</xsl:attribute>
			<xsl:for-each select="ThirdPartyFlatFileDetail">
				<ThirdPartyFlatFileDetail>

					<!-- just try to make trd_id field of string type because it creates problem while creating csv file -->
					<TaxlotState>
						<xsl:value-of select ="TaxLotState"/>
					</TaxlotState>
					
					<trd_id>
						<xsl:value-of select="PBUniqueID"/>
					</trd_id>
					<!-- Side Starts-->	
					<xsl:choose>
						<xsl:when test="Side='Buy' or Side='Buy to Open'">
							<txn_code>
								<xsl:value-of select="'BY'"/>
							</txn_code>
						</xsl:when>
						<xsl:when test="Side='Buy to Close' or Side='Buy to Cover'">
							<txn_code>
								<xsl:value-of select="'CS'"/>
							</txn_code>
						</xsl:when>
						<xsl:when test="Side='Sell' or Side='Sell to Close'">
							<txn_code>
								<xsl:value-of select="'SL'"/>
							</txn_code>
						</xsl:when>
						<xsl:when test="Side='Sell short' or Side='Sell to Open'">
							<txn_code>
								<xsl:value-of select="'SS'"/>
							</txn_code>
						</xsl:when>
						<xsl:otherwise >
							<txn_code>
								<xsl:value-of select="' '"/>
							</txn_code>
						</xsl:otherwise>
					</xsl:choose >

					<!--   Side End    -->

					<qty_filled>
						<xsl:value-of select="AllocatedQty"/>
					</qty_filled>

					<xsl:variable name ="varCheckSymbolUnderlying">
						<xsl:value-of select ="substring-before(Symbol,'-')"/>
					</xsl:variable>
					<xsl:choose>
						<xsl:when test="SEDOL != '' and $varCheckSymbolUnderlying != '' and Asset != 'FX'">
							<symbol>
								<xsl:value-of select="SEDOL"/>
							</symbol>
						</xsl:when>
						<xsl:when test="ISIN != '' and $varCheckSymbolUnderlying != '' and Asset != 'FX'">
							<symbol>
								<xsl:value-of select="ISIN"/>
							</symbol>
						</xsl:when>
						<xsl:when test="CUSIP != '' and $varCheckSymbolUnderlying != '' and Asset != 'FX'">
							<symbol>
								<xsl:value-of select="CUSIP"/>
							</symbol>
						</xsl:when>
            <xsl:when test="Asset = 'EquityOption' ">
              <symbol>
                <xsl:value-of select="OpraOptionSymbol"/>
              </symbol>
            </xsl:when >
						<xsl:otherwise>
							<symbol>
								<xsl:value-of select="Symbol"/>
							</symbol>
						</xsl:otherwise>
					</xsl:choose>					
					
					<price>
						<xsl:value-of select="AveragePrice"/>
					</price>

					<cl_id>
						<xsl:value-of select="FundAccountNo"/>
					</cl_id>

					<CounterPartyID>
						<xsl:value-of select="CounterPartyID"/>
					</CounterPartyID>
					<xsl:choose>
						<xsl:when test ="CounterParty ='Merrill'">
					<exec_brk>
								<xsl:value-of select ="'MLCO'"/>
					</exec_brk>
						</xsl:when>
						<xsl:when test ="CounterParty ='FIDL'">
							<exec_brk>
								<xsl:value-of select ="'FIBS'"/>
							</exec_brk>
						</xsl:when>
						<xsl:when test ="CounterParty ='RBCB'">
							<exec_brk>
								<xsl:value-of select ="'RBCD'"/>
							</exec_brk>
						</xsl:when>
						<xsl:otherwise >
							<exec_brk>
								<xsl:value-of select="translate(CounterParty, $vLowercaseChars_CONST , $vUppercaseChars_CONST)"/>
							</exec_brk>
						</xsl:otherwise>
					</xsl:choose>
					

					<trade_date>
						<xsl:value-of select="TradeDate"/>
					</trade_date>

					<xsl:for-each select="AssetID">
						<AssetID>
							<xsl:value-of select="."/>
						</AssetID>
					</xsl:for-each>

					<!-- Starts Asset Type -->
					<xsl:choose>
						<xsl:when test="Asset='Equity'">
							<ass_type>
								<xsl:value-of select="'50'"/>
							</ass_type>
						</xsl:when>
						<xsl:when test="Asset='EquityOption'">
							<ass_type>
								<xsl:value-of select="'60'"/>
							</ass_type>
						</xsl:when>
						<xsl:when test="Asset='Cash'">
							<ass_type>
								<xsl:value-of select="'1'"/>
							</ass_type>
						</xsl:when>
						<xsl:when test="Asset='FixedIncome'">
							<ass_type>
								<xsl:value-of select="'10'"/>
							</ass_type>
						</xsl:when>
						<xsl:otherwise>
							<ass_type>
								<xsl:value-of select="' '"/>
							</ass_type>
						</xsl:otherwise>
					</xsl:choose >

					<!--Ends Asset Type -->

					<commis_type>
						<xsl:value-of select="'T'"/>
					</commis_type>

					<commis>
						<xsl:value-of select="CommissionCharged"/>
					</commis>


					<settle_date>
						<xsl:value-of select="' '"/>
					</settle_date>

					<cmeth>
						<xsl:value-of select ="' '"/>
					</cmeth>

					<vp_date>
						<xsl:value-of select ="' '"/>
					</vp_date>

					<assigned_usr>
						<xsl:value-of select ="' '"/>
					</assigned_usr>

					<custodian>
						<xsl:value-of select ="' '"/>
					</custodian>

					<!--<alloc_shares>
						<xsl:value-of select ="AllocatedQty"/>
					</alloc_shares>-->

					<target>
						<xsl:value-of select ="' '"/>
					</target>

					<currency>
						<xsl:value-of select ="' '"/>
					</currency>			

					<stl_cur>
						<xsl:value-of select ="CurrencySymbol"/>
					</stl_cur>

					<m_exe_rate>
						<xsl:value-of select ="' '"/>
					</m_exe_rate>
					
					<exchange>
						<xsl:value-of select ="Exchange"/>
					</exchange>

					<oth_fee>
						<xsl:value-of select ="OtherBrokerFee"/>
					</oth_fee>

					<manager>
						<xsl:value-of select ="' '"/>
					</manager>
									

					<!--Id Fields Save purpose in the database -->

					<xsl:for-each select="SideID">
						<SideID>
							<xsl:value-of select="."/>
						</SideID>
					</xsl:for-each>
					<xsl:for-each select="CompanyID">
						<CompanyID>
							<xsl:value-of select="."/>
						</CompanyID>
					</xsl:for-each>
					<xsl:for-each select="ThirdPartyID">
						<ThirdPartyID>
							<xsl:value-of select="."/>
						</ThirdPartyID>
					</xsl:for-each>
					<xsl:for-each select="CurrencyID">
						<CurrencyID>
							<xsl:value-of select="."/>
						</CurrencyID>
					</xsl:for-each>
					<xsl:for-each select="CompanyFundID">
						<CompanyFundID>
							<xsl:value-of select="."/>
						</CompanyFundID>
					</xsl:for-each>

					<xsl:for-each select="ExchangeID">
						<ExchangeID>
							<xsl:value-of select="."/>
						</ExchangeID>
					</xsl:for-each>

					<xsl:for-each select="UnderLyingID">
						<UnderLyingID>
							<xsl:value-of select="."/>
						</UnderLyingID>
					</xsl:for-each>

					<xsl:for-each select="AUECID">
						<AUECID>
							<xsl:value-of select="."/>
						</AUECID>
					</xsl:for-each>

					<xsl:for-each select="CommissionRateTypeID">
						<CommissionRateTypeID>
							<xsl:value-of select="."/>
						</CommissionRateTypeID>
					</xsl:for-each>

					<xsl:for-each select="CVID">
						<CVID>
							<xsl:value-of select="."/>
						</CVID>
					</xsl:for-each>

					<xsl:for-each select="CompanyFundTypeID">
						<CompanyFundTypeID>
							<xsl:value-of select="."/>
						</CompanyFundTypeID>
					</xsl:for-each>

					<xsl:for-each select="ThirdPartyTypeID">
						<ThirdPartyTypeID>
							<xsl:value-of select="."/>
						</ThirdPartyTypeID>
					</xsl:for-each>

					<xsl:for-each select="CompanyCVID">
						<CompanyCVID>
							<xsl:value-of select="."/>
						</CompanyCVID>
					</xsl:for-each>

					<xsl:for-each select="EntityID">
						<EntityID>
							<xsl:value-of select="."/>
						</EntityID>
					</xsl:for-each>
					<xsl:for-each select="OrderID">
						<OrderID>
							<xsl:value-of select="."/>
						</OrderID>
					</xsl:for-each>
					<xsl:for-each select="TradAccntID">
						<TradAccntID>
							<xsl:value-of select="."/>
						</TradAccntID>
					</xsl:for-each>

				</ThirdPartyFlatFileDetail>
			</xsl:for-each>
		</ThirdPartyFlatFileDetailCollection>
	</xsl:template>
	<!-- variable declaration for lower to upper case -->

	<xsl:variable name="vLowercaseChars_CONST" select="'abcdefghijklmnopqrstuvwxyz'"/>
	<xsl:variable name="vUppercaseChars_CONST" select="'ABCDEFGHIJKLMNOPQRSTUVWXYZ'"/>

	<!-- variable declaration for lower to upper case ENDs -->
</xsl:stylesheet>
